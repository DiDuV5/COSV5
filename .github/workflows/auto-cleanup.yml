name: è‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶

on:
  schedule:
    # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹æ‰§è¡Œæ¸…ç†
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'æ˜¯å¦ä¸ºæ¨¡æ‹Ÿè¿è¡Œ'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      cleanup_level:
        description: 'æ¸…ç†çº§åˆ«'
        required: false
        default: 'standard'
        type: choice
        options:
          - 'minimal'    # ä»…æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          - 'standard'   # æ ‡å‡†æ¸…ç†
          - 'aggressive' # æ·±åº¦æ¸…ç†

jobs:
  auto-cleanup:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼ˆæ¸…ç†å‰ï¼‰
        run: |
          echo "=== æ¸…ç†å‰ç£ç›˜ä½¿ç”¨æƒ…å†µ ==="
          df -h
          echo "=== é¡¹ç›®ç›®å½•å¤§å° ==="
          du -sh . --exclude=node_modules
          du -sh node_modules 2>/dev/null || echo "node_modulesä¸å­˜åœ¨"
      
      - name: èµ‹äºˆæ¸…ç†è„šæœ¬æ‰§è¡Œæƒé™
        run: chmod +x scripts/auto-cleanup-enhanced.sh
      
      - name: æ‰§è¡Œè‡ªåŠ¨æ¸…ç†ï¼ˆæ¨¡æ‹Ÿæ¨¡å¼ï¼‰
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "ğŸ” æ‰§è¡Œæ¨¡æ‹Ÿæ¸…ç†..."
          ./scripts/auto-cleanup-enhanced.sh true
      
      - name: æ‰§è¡Œè‡ªåŠ¨æ¸…ç†ï¼ˆå®é™…æ¨¡å¼ï¼‰
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "ğŸ§¹ æ‰§è¡Œå®é™…æ¸…ç†..."
          ./scripts/auto-cleanup-enhanced.sh false
      
      - name: æ¸…ç†node_modulesç¼“å­˜ï¼ˆæ·±åº¦æ¸…ç†æ¨¡å¼ï¼‰
        if: github.event.inputs.cleanup_level == 'aggressive'
        run: |
          echo "ğŸ—‘ï¸ æ‰§è¡Œæ·±åº¦æ¸…ç†..."
          # æ¸…ç†npmç¼“å­˜
          npm cache clean --force
          # æ¸…ç†yarnç¼“å­˜ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          yarn cache clean 2>/dev/null || true
          # æ¸…ç†.nextç¼“å­˜
          rm -rf .next/cache/* 2>/dev/null || true
          echo "æ·±åº¦æ¸…ç†å®Œæˆ"
      
      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼ˆæ¸…ç†åï¼‰
        run: |
          echo "=== æ¸…ç†åç£ç›˜ä½¿ç”¨æƒ…å†µ ==="
          df -h
          echo "=== é¡¹ç›®ç›®å½•å¤§å° ==="
          du -sh . --exclude=node_modules
          du -sh node_modules 2>/dev/null || echo "node_modulesä¸å­˜åœ¨"
      
      - name: è¿è¡ŒåŸºæœ¬éªŒè¯
        run: |
          echo "ğŸ” éªŒè¯é¡¹ç›®å®Œæ•´æ€§..."
          # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          test -f package.json && echo "âœ… package.jsonå­˜åœ¨"
          test -f next.config.js && echo "âœ… next.config.jså­˜åœ¨"
          test -f tsconfig.json && echo "âœ… tsconfig.jsonå­˜åœ¨"
          
          # æ£€æŸ¥å…³é”®ç›®å½•æ˜¯å¦å­˜åœ¨
          test -d src && echo "âœ… srcç›®å½•å­˜åœ¨"
          test -d prisma && echo "âœ… prismaç›®å½•å­˜åœ¨"
          
          echo "é¡¹ç›®å®Œæ•´æ€§éªŒè¯é€šè¿‡"
      
      - name: ä¸Šä¼ æ¸…ç†æŠ¥å‘Š
        if: github.event.inputs.dry_run != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: cleanup-report-${{ github.run_number }}
          path: |
            cleanup-report-*.md
            cleanup-backup-*/**
          retention-days: 30
      
      - name: åˆ›å»ºæ¸…ç†æ€»ç»“è¯„è®º
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // æŸ¥æ‰¾æœ€æ–°çš„æ¸…ç†æŠ¥å‘Š
            const files = fs.readdirSync('.');
            const reportFile = files.find(f => f.startsWith('cleanup-report-'));
            
            if (reportFile) {
              const reportContent = fs.readFileSync(reportFile, 'utf8');
              
              const comment = `## ğŸ§¹ è‡ªåŠ¨æ¸…ç†æ‰§è¡Œå®Œæˆ
              
**æ‰§è¡Œæ—¶é—´**: ${new Date().toLocaleString('zh-CN')}
**è§¦å‘æ–¹å¼**: æ‰‹åŠ¨æ‰§è¡Œ
**æ¸…ç†çº§åˆ«**: ${{ github.event.inputs.cleanup_level }}

### æ¸…ç†æŠ¥å‘Š
\`\`\`
${reportContent}
\`\`\`

### ä¸‹è½½
- [æ¸…ç†æŠ¥å‘Šå’Œå¤‡ä»½æ–‡ä»¶](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

---
*æ­¤è¯„è®ºç”±è‡ªåŠ¨æ¸…ç†å·¥ä½œæµç”Ÿæˆ*`;

              // å¦‚æœæ˜¯PRè§¦å‘ï¼Œæ·»åŠ è¯„è®ºåˆ°PR
              if (context.payload.pull_request) {
                github.rest.issues.createComment({
                  issue_number: context.payload.pull_request.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            }

  cleanup-monitoring:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    needs: auto-cleanup
    
    steps:
      - name: ç›‘æ§æ¸…ç†æ•ˆæœ
        run: |
          echo "ğŸ“Š ç›‘æ§æ¸…ç†æ•ˆæœ..."
          echo "å®šæœŸæ¸…ç†å·²å®Œæˆï¼Œé¡¹ç›®ä¿æŒæ¸…æ´çŠ¶æ€"
          
      - name: å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        run: |
          echo "ğŸ“§ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é€šçŸ¥é€»è¾‘"
          echo "ä¾‹å¦‚ï¼šå‘é€é‚®ä»¶ã€Slackæ¶ˆæ¯æˆ–å…¶ä»–é€šçŸ¥"
