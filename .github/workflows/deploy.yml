name: CoserEden Production Deployment

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production

env:
  NODE_VERSION: '18.x'
  SERVER_HOST: '185.170.198.240'
  SERVER_USER: 'root'
  DEPLOY_PATH: '/var/www/cosereeden'

jobs:
  test:
    runs-on: ubuntu-latest
    name: ğŸ§ª Test & Quality Check

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ” ESLint check
      run: npm run lint:check

    - name: ğŸ—ï¸ TypeScript check
      run: npm run type-check

    - name: ğŸ§ª Run tests
      run: npm run test
      env:
        NODE_ENV: test

  build:
    runs-on: ubuntu-latest
    needs: test
    name: ğŸ—ï¸ Build Application

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ—ï¸ Build Next.js application
      run: npm run build
      env:
        NODE_ENV: production
        NEXTAUTH_URL: https://tutu365.cc
        NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        CLOUDFLARE_R2_ENDPOINT: https://e0a67a18c91c9a92d9ff633f911a6ca1.r2.cloudflarestorage.com
        CLOUDFLARE_R2_BUCKET_NAME: tut
        CLOUDFLARE_R2_CDN_DOMAIN: https://cc.tutu365.cc

    - name: ğŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: |
          .next/
          public/
          package.json
          package-lock.json
          prisma/
        retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: [test, build]
    name: ğŸš€ Deploy to Production
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment:
      name: production
      url: https://tutu365.cc

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¤ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files

    - name: ğŸ” Setup SSH key
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: ğŸ“‹ Create production environment file
      run: |
        cat > .env.production << EOF
        NODE_ENV=production
        NEXTAUTH_URL=https://tutu365.cc
        NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
        DATABASE_URL=${{ secrets.DATABASE_URL }}

        # Cloudflare R2 Storage
        CLOUDFLARE_R2_ACCOUNT_ID=e0a67a18c91c9a92d9ff633f911a6ca1
        CLOUDFLARE_R2_ACCESS_KEY_ID=${{ secrets.CLOUDFLARE_R2_ACCESS_KEY_ID }}
        CLOUDFLARE_R2_SECRET_ACCESS_KEY=${{ secrets.CLOUDFLARE_R2_SECRET_ACCESS_KEY }}
        CLOUDFLARE_R2_BUCKET_NAME=tut
        CLOUDFLARE_R2_ENDPOINT=https://e0a67a18c91c9a92d9ff633f911a6ca1.r2.cloudflarestorage.com
        CLOUDFLARE_R2_CDN_DOMAIN=https://cc.tutu365.cc
        CLOUDFLARE_R2_PUBLIC_URL=https://cc.tutu365.cc

        # Telegram Bot
        TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_BOT_USERNAME=TuTu365bot

        # é‚®ä»¶é…ç½® (Hostinger)
        SMTP_HOST=smtp.hostinger.com
        SMTP_PORT=465
        SMTP_SECURE=true
        SMTP_USER=tu@tutu365.cc
        SMTP_PASS=${{ secrets.SMTP_PASS }}
        SMTP_FROM="CoserEden <tu@tutu365.cc>"

        # CDN Configuration
        CDN_ENVIRONMENT=production
        CDN_PRODUCTION_PRIMARY=https://cc.tutu365.cc
        CDN_PRODUCTION_BACKUP=https://cc.tutu365.com

        # Storage Configuration
        USE_NEW_STORAGE_SYSTEM=true
        STORAGE_PROVIDER=cloudflare-r2
        EOF

    - name: ğŸ“¦ Create deployment package
      run: |
        tar -czf deployment.tar.gz \
          .next/ \
          public/ \
          package.json \
          package-lock.json \
          prisma/ \
          .env.production

    - name: ğŸš€ Deploy to server
      run: |
        # ä¸Šä¼ éƒ¨ç½²åŒ…åˆ°æœåŠ¡å™¨
        scp -o StrictHostKeyChecking=no deployment.tar.gz ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:/tmp/

        # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
        ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'EOF'
          set -e

          echo "ğŸš€ å¼€å§‹éƒ¨ç½²CoserEdenåˆ°ç”Ÿäº§ç¯å¢ƒ..."

          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          mkdir -p ${{ env.DEPLOY_PATH }}
          cd ${{ env.DEPLOY_PATH }}

          # å¤‡ä»½å½“å‰ç‰ˆæœ¬
          if [ -d ".next" ]; then
            echo "ğŸ“¦ å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
            sudo mv .next .next.backup.$(date +%Y%m%d_%H%M%S) || true
            sudo mv public public.backup.$(date +%Y%m%d_%H%M%S) || true
          fi

          # è§£å‹æ–°ç‰ˆæœ¬
          echo "ğŸ“¤ è§£å‹æ–°ç‰ˆæœ¬..."
          tar -xzf /tmp/deployment.tar.gz

          # å®‰è£…Node.js (å¦‚æœæœªå®‰è£…)
          if ! command -v node &> /dev/null; then
            echo "ğŸ“¦ å®‰è£…Node.js..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi

          # å®‰è£…PM2 (å¦‚æœæœªå®‰è£…)
          if ! command -v pm2 &> /dev/null; then
            echo "ğŸ“¦ å®‰è£…PM2..."
            sudo npm install -g pm2
          fi

          # å®‰è£…ç”Ÿäº§ä¾èµ–
          echo "ğŸ“¦ å®‰è£…ç”Ÿäº§ä¾èµ–..."
          npm ci --production --silent

          # è¿è¡Œæ•°æ®åº“è¿ç§»
          echo "ğŸ—„ï¸ è¿è¡Œæ•°æ®åº“è¿ç§»..."
          npx prisma generate
          npx prisma db push

          # åˆ›å»ºPM2é…ç½®æ–‡ä»¶
          cat > ecosystem.config.js << 'EOFPM2'
          module.exports = {
            apps: [{
              name: 'cosereeden',
              script: 'npm',
              args: 'start',
              cwd: '${{ env.DEPLOY_PATH }}',
              instances: 'max',
              exec_mode: 'cluster',
              env: {
                NODE_ENV: 'production',
                PORT: 3000
              },
              error_file: '/var/log/cosereeden/error.log',
              out_file: '/var/log/cosereeden/out.log',
              log_file: '/var/log/cosereeden/combined.log',
              time: true,
              max_memory_restart: '1G',
              node_args: '--max-old-space-size=1024'
            }]
          };
          EOFPM2

          # åˆ›å»ºæ—¥å¿—ç›®å½•
          sudo mkdir -p /var/log/cosereeden
          sudo chown -R $USER:$USER /var/log/cosereeden

          # å¯åŠ¨æˆ–é‡å¯åº”ç”¨
          echo "ğŸ”„ å¯åŠ¨åº”ç”¨..."
          pm2 reload ecosystem.config.js --env production || pm2 start ecosystem.config.js --env production

          # ä¿å­˜PM2é…ç½®
          pm2 save
          pm2 startup

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f /tmp/deployment.tar.gz

          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        EOF

    - name: ğŸ” Health check
      run: |
        echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        sleep 15

        # æ£€æŸ¥åº”ç”¨æ˜¯å¦å¯åŠ¨
        ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'EOF'
          # æ£€æŸ¥PM2è¿›ç¨‹çŠ¶æ€
          pm2 status cosereeden

          # æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬
          if netstat -tuln | grep -q ":3000 "; then
            echo "âœ… åº”ç”¨ç«¯å£3000æ­£åœ¨ç›‘å¬"
          else
            echo "âŒ åº”ç”¨ç«¯å£3000æœªç›‘å¬"
            exit 1
          fi

          # æ£€æŸ¥åº”ç”¨å“åº”
          if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
            echo "âœ… åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ åº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥"
            exit 1
          fi
        EOF

    - name: ğŸ”” Notify deployment result
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          STATUS="âœ… éƒ¨ç½²æˆåŠŸ"
          MESSAGE="ğŸ‰ CoserEdenç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼

        ğŸŒ ä¸»åŸŸå: https://tutu365.cc
        ğŸŒ å¤‡ç”¨åŸŸå: https://tutu365.com
        ğŸ“¦ ç‰ˆæœ¬: ${{ github.sha }}
        ğŸ• éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')

        ğŸš€ æ–°åŠŸèƒ½å·²ä¸Šçº¿ï¼Œ4600+ä¸“ä¸šcosplayåˆ›ä½œè€…å¯ä»¥äº«å—æ›´å¥½çš„æœåŠ¡ï¼"
        else
          STATUS="âŒ éƒ¨ç½²å¤±è´¥"
          MESSAGE="âš ï¸ CoserEdenç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼

        ğŸ“¦ ç‰ˆæœ¬: ${{ github.sha }}
        ğŸ• å¤±è´¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
        ğŸ“‹ æŸ¥çœ‹æ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

        è¯·ç«‹å³æ£€æŸ¥å¹¶ä¿®å¤é—®é¢˜ï¼"
        fi

        # å‘é€Telegramé€šçŸ¥
        curl -X POST "https://api.telegram.org/bot8176653187:AAE4_lLOwAl9h0i1bNlLDh4GCiGKaOtYgeo/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
            \"text\": \"$MESSAGE\",
            \"parse_mode\": \"HTML\"
          }" || echo "Telegramé€šçŸ¥å‘é€å¤±è´¥"

  cleanup:
    runs-on: ubuntu-latest
    needs: deploy
    name: ğŸ§¹ Cleanup
    if: always()

    steps:
    - name: ğŸ—‘ï¸ Clean up artifacts
      uses: actions/github-script@v7
      with:
        script: |
          const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: context.runId,
          });

          for (const artifact of artifacts.data.artifacts) {
            await github.rest.actions.deleteArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: artifact.id,
            });
          }

          console.log('âœ… æ„å»ºäº§ç‰©æ¸…ç†å®Œæˆ');
