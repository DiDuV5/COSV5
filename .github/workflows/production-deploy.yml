name: CoserEden Production CI/CD

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: "å¼ºåˆ¶éƒ¨ç½²ï¼ˆè·³è¿‡æµ‹è¯•ï¼‰"
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: "18.20.8"
  PNPM_VERSION: "8.15.6"
  APP_NAME: "cosereeden"

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•
  quality-check:
    name: ğŸ§ª Quality Check & Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.force_deploy != 'true'

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: cosereeden_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ¯ Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: ğŸ—„ï¸ Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” TypeScript type check
        run: pnpm run type-check

      - name: ğŸ§¹ ESLint check
        run: pnpm run lint

      - name: ğŸ—ï¸ Build test
        run: pnpm run build
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/cosereeden_test
          REDIS_URL: redis://localhost:6379
          NEXTAUTH_SECRET: test-secret-key-for-ci
          NEXTAUTH_URL: http://localhost:3000
          NEXT_PUBLIC_APP_URL: http://localhost:3000

      - name: ğŸ§ª Run unit tests
        run: pnpm run test:ci
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/cosereeden_test
          REDIS_URL: redis://localhost:6379
          NEXTAUTH_SECRET: test-secret-key-for-ci

      - name: ğŸ“Š Upload test coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # æ„å»ºç”Ÿäº§ç‰ˆæœ¬
  build-production:
    name: ğŸ—ï¸ Build Production
    runs-on: ubuntu-latest
    needs: quality-check
    if: github.ref == 'refs/heads/main' && (success() || github.event.inputs.force_deploy == 'true')

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ¯ Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: ğŸ—„ï¸ Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build production
        run: pnpm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_APP_URL: https://cosv5.com
          NEXTAUTH_URL: https://cosv5.com

      - name: ğŸ“¦ Create deployment package
        run: |
          # åˆ›å»ºéƒ¨ç½²åŒ…ç›®å½•
          mkdir -p deploy-package

          # å¤åˆ¶æ„å»ºæ–‡ä»¶
          cp -r .next deploy-package/
          cp -r public deploy-package/
          cp package.json deploy-package/
          cp pnpm-lock.yaml deploy-package/
          cp next.config.js deploy-package/

          # å¤åˆ¶æ•°æ®åº“ç›¸å…³æ–‡ä»¶
          if [ -d "prisma" ]; then
            cp -r prisma deploy-package/
          fi

          # åˆ›å»ºå¯åŠ¨è„šæœ¬
          cat > deploy-package/server.js << 'EOF'
          const { createServer } = require('http')
          const { parse } = require('url')
          const next = require('next')

          const dev = process.env.NODE_ENV !== 'production'
          const hostname = process.env.HOSTNAME || 'localhost'
          const port = parseInt(process.env.PORT, 10) || 3000

          const app = next({ dev, hostname, port })
          const handle = app.getRequestHandler()

          app.prepare().then(() => {
            createServer(async (req, res) => {
              try {
                const parsedUrl = parse(req.url, true)
                await handle(req, res, parsedUrl)
              } catch (err) {
                console.error('Error occurred handling', req.url, err)
                res.statusCode = 500
                res.end('internal server error')
              }
            })
            .once('error', (err) => {
              console.error(err)
              process.exit(1)
            })
            .listen(port, () => {
              console.log(`> Ready on http://${hostname}:${port}`)

              // é€šçŸ¥PM2åº”ç”¨å·²å‡†å¤‡å°±ç»ª
              if (process.send) {
                process.send('ready')
              }
            })
          })
          EOF

          # åˆ›å»ºå¥åº·æ£€æŸ¥API
          mkdir -p deploy-package/pages/api
          cat > deploy-package/pages/api/health.js << 'EOF'
          export default function handler(req, res) {
            res.status(200).json({
              status: 'ok',
              timestamp: new Date().toISOString(),
              version: process.env.npm_package_version || '1.0.0',
              uptime: process.uptime()
            })
          }
          EOF

          # åˆ›å»ºéƒ¨ç½²åŒ…
          tar -czf deploy-package.tar.gz -C deploy-package .

          # æ˜¾ç¤ºåŒ…å¤§å°
          ls -lh deploy-package.tar.gz

      - name: ğŸ“¤ Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-deployment-${{ github.sha }}
          path: deploy-package.tar.gz
          retention-days: 7

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-production]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://cosv5.com

    steps:
      - name: ğŸ“¥ Checkout deployment scripts
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            scripts/
          sparse-checkout-cone-mode: false

      - name: ğŸ“¥ Download deployment artifact
        uses: actions/download-artifact@v4
        with:
          name: production-deployment-${{ github.sha }}

      - name: ğŸ”‘ Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ“¤ Upload deployment package
        run: |
          scp -i ~/.ssh/deploy_key deploy-package.tar.gz ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/tmp/deploy-${{ github.sha }}.tar.gz

      - name: ğŸš€ Execute deployment
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            set -e

            # è®¾ç½®å˜é‡
            APP_DIR="/var/www/cosereeden"
            RELEASE_DIR="$APP_DIR/releases/$(date +%Y%m%d_%H%M%S)"
            BACKUP_DIR="/var/backups/cosereeden"
            DEPLOY_PACKAGE="/tmp/deploy-${{ github.sha }}.tar.gz"

            echo "ğŸš€ å¼€å§‹éƒ¨ç½² CoserEden..."
            echo "ğŸ“¦ ç‰ˆæœ¬: ${{ github.sha }}"
            echo "ğŸ“ å‘å¸ƒç›®å½•: $RELEASE_DIR"

            # åˆ›å»ºå‘å¸ƒç›®å½•
            mkdir -p "$RELEASE_DIR"

            # è§£å‹éƒ¨ç½²åŒ…
            echo "ğŸ“¤ è§£å‹éƒ¨ç½²åŒ…..."
            tar -xzf "$DEPLOY_PACKAGE" -C "$RELEASE_DIR"

            # é“¾æ¥å…±äº«æ–‡ä»¶å’Œç›®å½•
            echo "ğŸ”— é“¾æ¥å…±äº«èµ„æº..."
            ln -sf "$APP_DIR/shared/.env.production" "$RELEASE_DIR/.env.production"
            ln -sf "$APP_DIR/shared/uploads" "$RELEASE_DIR/public/uploads"

            # å®‰è£…ç”Ÿäº§ä¾èµ–
            echo "ğŸ“¦ å®‰è£…ç”Ÿäº§ä¾èµ–..."
            cd "$RELEASE_DIR"
            npm ci --only=production --silent

            # è¿è¡Œæ•°æ®åº“è¿ç§»
            if [ -f "prisma/schema.prisma" ]; then
              echo "ğŸ—„ï¸ è¿è¡Œæ•°æ®åº“è¿ç§»..."
              npx prisma generate
              npx prisma migrate deploy
            fi

            # å¤‡ä»½å½“å‰ç‰ˆæœ¬
            if [ -L "$APP_DIR/current" ]; then
              CURRENT_RELEASE=$(readlink "$APP_DIR/current")
              if [ -d "$CURRENT_RELEASE" ]; then
                BACKUP_NAME="backup-$(date +%Y%m%d_%H%M%S)"
                echo "ğŸ’¾ å¤‡ä»½å½“å‰ç‰ˆæœ¬åˆ°: $BACKUP_DIR/$BACKUP_NAME"
                mkdir -p "$BACKUP_DIR"
                cp -r "$CURRENT_RELEASE" "$BACKUP_DIR/$BACKUP_NAME"
              fi
            fi

            # åŸå­æ€§åˆ‡æ¢ç‰ˆæœ¬
            echo "ğŸ”„ åˆ‡æ¢åˆ°æ–°ç‰ˆæœ¬..."
            ln -sfn "$RELEASE_DIR" "$APP_DIR/current"

            # é‡å¯åº”ç”¨
            echo "ğŸ”„ é‡å¯åº”ç”¨..."
            cd "$APP_DIR/current"
            pm2 startOrRestart "$APP_DIR/shared/ecosystem.config.js" --env production

            # ç­‰å¾…åº”ç”¨å¯åŠ¨
            echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨..."
            sleep 15

            # å¥åº·æ£€æŸ¥
            echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            HEALTH_CHECK_PASSED=false
            for i in {1..6}; do
              if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
                echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ (å°è¯• $i/6)"
                HEALTH_CHECK_PASSED=true
                break
              else
                echo "â³ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œç­‰å¾…é‡è¯•... (å°è¯• $i/6)"
                sleep 10
              fi
            done

            if [ "$HEALTH_CHECK_PASSED" = true ]; then
              echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
              pm2 save

              # æ¸…ç†æ—§ç‰ˆæœ¬ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰
              echo "ğŸ§¹ æ¸…ç†æ—§ç‰ˆæœ¬..."
              cd "$APP_DIR/releases"
              ls -t | tail -n +6 | xargs -r rm -rf

              # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘10ä¸ªï¼‰
              cd "$BACKUP_DIR"
              ls -t | tail -n +11 | xargs -r rm -rf

            else
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."

              # å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
              if [ -d "$BACKUP_DIR" ]; then
                LAST_BACKUP=$(ls -t "$BACKUP_DIR" | head -1)
                if [ -n "$LAST_BACKUP" ]; then
                  echo "ğŸ”„ å›æ»šåˆ°ç‰ˆæœ¬: $LAST_BACKUP"
                  ln -sfn "$BACKUP_DIR/$LAST_BACKUP" "$APP_DIR/current"
                  pm2 restart cosereeden
                  sleep 10

                  # éªŒè¯å›æ»š
                  if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
                    echo "âœ… å›æ»šæˆåŠŸ"
                  else
                    echo "âŒ å›æ»šå¤±è´¥"
                  fi
                fi
              fi

              exit 1
            fi

            # æ¸…ç†éƒ¨ç½²åŒ…
            rm -f "$DEPLOY_PACKAGE"

            echo "ğŸ‰ éƒ¨ç½²æµç¨‹å®Œæˆï¼"
          EOF

      - name: ğŸ§¹ Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

      - name: ğŸ“± Send success notification
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="ğŸ‰ <b>CoserEden éƒ¨ç½²æˆåŠŸï¼</b>

          ğŸš€ <b>ç‰ˆæœ¬:</b> <code>${{ github.sha }}</code>
          ğŸŒ <b>ç¯å¢ƒ:</b> Production
          ğŸ‘¤ <b>æäº¤è€…:</b> ${{ github.actor }}
          ğŸ“ <b>æäº¤ä¿¡æ¯:</b> ${{ github.event.head_commit.message }}

          ğŸ”— <b>è®¿é—®åœ°å€:</b>
          â€¢ <a href='https://cosv5.com'>cosv5.com</a>
          â€¢ <a href='https://cosv5.cc'>cosv5.cc</a>
          â€¢ <a href='https://cosv5.vip'>cosv5.vip</a>

          â° <b>éƒ¨ç½²æ—¶é—´:</b> $(date '+%Y-%m-%d %H:%M:%S UTC')"

      - name: ğŸ“± Send failure notification
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="âŒ <b>CoserEden éƒ¨ç½²å¤±è´¥ï¼</b>

          ğŸš€ <b>ç‰ˆæœ¬:</b> <code>${{ github.sha }}</code>
          ğŸŒ <b>ç¯å¢ƒ:</b> Production
          ğŸ‘¤ <b>æäº¤è€…:</b> ${{ github.actor }}
          ğŸ“ <b>æäº¤ä¿¡æ¯:</b> ${{ github.event.head_commit.message }}

          ğŸ”— <b>æŸ¥çœ‹æ—¥å¿—:</b> <a href='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'>GitHub Actions</a>

          âš ï¸ <b>è¯·ç«‹å³æ£€æŸ¥å¹¶ä¿®å¤é—®é¢˜ï¼</b>
          â° <b>å¤±è´¥æ—¶é—´:</b> $(date '+%Y-%m-%d %H:%M:%S UTC')"
