name: çŽ¯å¢ƒå˜é‡åˆè§„æ€§æ£€æŸ¥

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  env-compliance:
    name: çŽ¯å¢ƒå˜é‡åˆè§„æ€§æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: è¿è¡ŒçŽ¯å¢ƒå˜é‡åˆè§„æ€§æ£€æŸ¥
        run: npm run check-env-compliance
        continue-on-error: false

      - name: è¿è¡Œé…ç½®éªŒè¯
        run: npm run validate-config
        continue-on-error: true

      - name: ç”Ÿæˆåˆè§„æ€§æŠ¥å‘Š
        if: failure()
        run: |
          echo "## ðŸš¨ çŽ¯å¢ƒå˜é‡åˆè§„æ€§æ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å‘çŽ°äº†ä¸ç¬¦åˆ COSEREEDEN_ å‰ç¼€è§„èŒƒçš„çŽ¯å¢ƒå˜é‡æˆ–ç¡¬ç¼–ç é…ç½®ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ä¿®å¤å»ºè®®" >> $GITHUB_STEP_SUMMARY
          echo "1. å°†æ‰€æœ‰çŽ¯å¢ƒå˜é‡æ›´æ–°ä¸ºä½¿ç”¨ COSEREEDEN_ å‰ç¼€" >> $GITHUB_STEP_SUMMARY
          echo "2. ç§»é™¤ç¡¬ç¼–ç çš„æ•æ„Ÿä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "3. ä½¿ç”¨ \`src/lib/config/env-compatibility.ts\` å·¥å…·è¿›è¡Œå…¼å®¹æ€§å¤„ç†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### è¯¦ç»†ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æŸ¥çœ‹ä¸Šæ–¹çš„æ£€æŸ¥è¾“å‡ºèŽ·å–å…·ä½“çš„è¿è§„é¡¹ç›®ã€‚" >> $GITHUB_STEP_SUMMARY

      - name: åˆè§„æ€§æ£€æŸ¥é€šè¿‡
        if: success()
        run: |
          echo "## âœ… çŽ¯å¢ƒå˜é‡åˆè§„æ€§æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ‰€æœ‰çŽ¯å¢ƒå˜é‡éƒ½ç¬¦åˆ COSEREEDEN_ å‰ç¼€è§„èŒƒï¼Œæ²¡æœ‰å‘çŽ°ç¡¬ç¼–ç é…ç½®é—®é¢˜ã€‚" >> $GITHUB_STEP_SUMMARY

  type-check:
    name: TypeScript ç±»åž‹æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: env-compliance

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: è¿è¡Œç±»åž‹æ£€æŸ¥
        run: npm run type-check

  lint:
    name: ESLint ä»£ç æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: env-compliance

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: è¿è¡Œ ESLint
        run: npm run lint

  security-audit:
    name: å®‰å…¨å®¡è®¡
    runs-on: ubuntu-latest
    needs: env-compliance

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: è¿è¡Œå®‰å…¨å®¡è®¡
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶
        run: |
          echo "æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ•æ„Ÿæ–‡ä»¶..."
          if [ -f ".env" ]; then
            echo "âŒ å‘çŽ° .env æ–‡ä»¶ï¼Œè¯·ç¡®ä¿ä¸è¦æäº¤æ•æ„Ÿä¿¡æ¯"
            exit 1
          fi
          if [ -f ".env.local" ]; then
            echo "âŒ å‘çŽ° .env.local æ–‡ä»¶ï¼Œè¯·ç¡®ä¿ä¸è¦æäº¤æ•æ„Ÿä¿¡æ¯"
            exit 1
          fi
          if [ -f ".env.production" ]; then
            echo "âŒ å‘çŽ° .env.production æ–‡ä»¶ï¼Œè¯·ç¡®ä¿ä¸è¦æäº¤æ•æ„Ÿä¿¡æ¯"
            exit 1
          fi
          echo "âœ… æœªå‘çŽ°æ•æ„Ÿæ–‡ä»¶"

  config-validation:
    name: é…ç½®éªŒè¯
    runs-on: ubuntu-latest
    needs: env-compliance

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: éªŒè¯ package.json
        run: |
          echo "éªŒè¯ package.json é…ç½®..."
          node -e "
            const pkg = require('./package.json');
            const scripts = pkg.scripts || {};

            // æ£€æŸ¥å¿…éœ€çš„è„šæœ¬
            const requiredScripts = ['check-env-compliance', 'type-check', 'lint'];
            const missing = requiredScripts.filter(script => !scripts[script]);

            if (missing.length > 0) {
              console.error('âŒ ç¼ºå°‘å¿…éœ€çš„è„šæœ¬:', missing.join(', '));
              process.exit(1);
            }

            console.log('âœ… package.json é…ç½®éªŒè¯é€šè¿‡');
          "

      - name: éªŒè¯ TypeScript é…ç½®
        run: |
          echo "éªŒè¯ TypeScript é…ç½®..."
          if [ ! -f "tsconfig.json" ]; then
            echo "âŒ ç¼ºå°‘ tsconfig.json æ–‡ä»¶"
            exit 1
          fi
          echo "âœ… TypeScript é…ç½®éªŒè¯é€šè¿‡"

      - name: éªŒè¯ ESLint é…ç½®
        run: |
          echo "éªŒè¯ ESLint é…ç½®..."
          if [ ! -f ".eslintrc.json" ] && [ ! -f ".eslintrc.js" ] && [ ! -f "eslint.config.js" ]; then
            echo "âŒ ç¼ºå°‘ ESLint é…ç½®æ–‡ä»¶"
            exit 1
          fi
          echo "âœ… ESLint é…ç½®éªŒè¯é€šè¿‡"

  summary:
    name: æ£€æŸ¥æ€»ç»“
    runs-on: ubuntu-latest
    needs: [env-compliance, type-check, lint, security-audit, config-validation]
    if: always()

    steps:
      - name: ç”Ÿæˆæ£€æŸ¥æ€»ç»“
        run: |
          echo "## ðŸŽ¯ CI/CD æ£€æŸ¥æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ£€æŸ¥é¡¹ç›® | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| çŽ¯å¢ƒå˜é‡åˆè§„æ€§ | ${{ needs.env-compliance.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript ç±»åž‹æ£€æŸ¥ | ${{ needs.type-check.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint ä»£ç æ£€æŸ¥ | ${{ needs.lint.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| å®‰å…¨å®¡è®¡ | ${{ needs.security-audit.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| é…ç½®éªŒè¯ | ${{ needs.config-validation.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.env-compliance.result }}" == "success" &&
                "${{ needs.type-check.result }}" == "success" &&
                "${{ needs.lint.result }}" == "success" &&
                "${{ needs.security-audit.result }}" == "success" &&
                "${{ needs.config-validation.result }}" == "success" ]]; then
            echo "### ðŸŽ‰ æ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡äº†ï¼" >> $GITHUB_STEP_SUMMARY
            echo "ä»£ç è´¨é‡ç¬¦åˆ CoserEden é¡¹ç›®æ ‡å‡†ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ éƒ¨åˆ†æ£€æŸ¥æœªé€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æŸ¥çœ‹ä¸Šæ–¹çš„è¯¦ç»†ä¿¡æ¯å¹¶ä¿®å¤ç›¸å…³é—®é¢˜ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
