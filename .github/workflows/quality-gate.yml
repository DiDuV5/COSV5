name: ğŸ›¡ï¸ Quality Gate

on:
  pull_request:
    branches: [master, develop]
  push:
    branches: [master, develop]

env:
  NODE_VERSION: "18"

jobs:
  # ğŸ” ä»£ç è´¨é‡åˆ†æ
  code-quality:
    name: ğŸ” Code Quality Analysis
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ”§ TypeScript strict check
        id: typescript
        run: |
          echo "ğŸ” Running enhanced TypeScript check..."

          # è¿è¡Œæˆ‘ä»¬çš„CIç±»å‹æ£€æŸ¥è„šæœ¬
          if ./scripts/ci-type-check.sh; then
            echo "typescript-status=passed" >> $GITHUB_OUTPUT
            echo "typescript-errors=0" >> $GITHUB_OUTPUT
            echo "âœ… TypeScript checks passed"
          else
            echo "typescript-status=failed" >> $GITHUB_OUTPUT

            # è®¡ç®—åŸºç¡€é”™è¯¯æ•°é‡
            TS_OUTPUT=$(npm run type-check 2>&1 || true)
            TS_ERRORS=$(echo "$TS_OUTPUT" | grep -c "error TS" || echo "0")
            echo "typescript-errors=$TS_ERRORS" >> $GITHUB_OUTPUT

            echo "âŒ TypeScript checks failed"
            echo "Basic TypeScript errors: $TS_ERRORS"
          fi

      - name: ğŸ¨ ESLint analysis
        id: eslint
        run: |
          echo "ğŸ¨ Running ESLint..."
          LINT_OUTPUT=$(npm run lint:check 2>&1 || true)
          LINT_ERRORS=$(echo "$LINT_OUTPUT" | grep -c " error " || echo "0")
          LINT_WARNINGS=$(echo "$LINT_OUTPUT" | grep -c " warning " || echo "0")

          echo "eslint-errors=$LINT_ERRORS" >> $GITHUB_OUTPUT
          echo "eslint-warnings=$LINT_WARNINGS" >> $GITHUB_OUTPUT
          echo "ESLint errors: $LINT_ERRORS, warnings: $LINT_WARNINGS"

          if [ "$LINT_ERRORS" -gt 0 ]; then
            echo "âŒ ESLint errors found"
            echo "$LINT_OUTPUT"
          else
            echo "âœ… No ESLint errors"
          fi

      - name: ğŸ’… Prettier check
        id: prettier
        run: |
          echo "ğŸ’… Running Prettier check..."
          if npm run format:check; then
            echo "âœ… Code formatting is correct"
            echo "prettier-status=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ Code formatting issues found"
            echo "prettier-status=failed" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“Š Generate quality report
        run: |
          cat << EOF > quality-report.md
          # ğŸ“Š Enhanced Code Quality Report

          ## ğŸ”§ TypeScript Analysis
          - **Basic Errors**: ${{ steps.typescript.outputs.typescript-errors }}
          - **Strict Check**: ${{ steps.typescript.outputs.typescript-status == 'passed' && 'âœ… Passed' || 'âš ï¸ Has warnings' }}
          - **Overall Status**: ${{ steps.typescript.outputs.typescript-status == 'passed' && 'âœ… Passed' || 'âŒ Failed' }}

          ## ğŸ¨ ESLint Analysis
          - **Errors**: ${{ steps.eslint.outputs.eslint-errors }}
          - **Warnings**: ${{ steps.eslint.outputs.eslint-warnings }}
          - **Status**: ${{ steps.eslint.outputs.eslint-errors == '0' && 'âœ… Passed' || 'âŒ Failed' }}

          ## ğŸ’… Code Formatting
          - **Status**: ${{ steps.prettier.outputs.prettier-status == 'passed' && 'âœ… Passed' || 'âŒ Failed' }}

          ## ğŸ“‹ Type Safety Report
          è¯¦ç»†çš„ç±»å‹æ£€æŸ¥æŠ¥å‘Šå·²ç”Ÿæˆï¼Œè¯·æŸ¥çœ‹CIæ—¥å¿—ä¸­çš„ç±»å‹æ£€æŸ¥æ‘˜è¦ã€‚

          ## ğŸ¯ Quality Gate Status
          ${{ steps.typescript.outputs.typescript-status == 'passed' && steps.eslint.outputs.eslint-errors == '0' && steps.prettier.outputs.prettier-status == 'passed' && 'âœ… **PASSED** - Ready for merge' || 'âŒ **FAILED** - Needs fixes before merge' }}
          EOF

      - name: ğŸ“ Comment PR with quality report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('quality-report.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: ğŸš« Fail if quality gate not met
        run: |
          TS_STATUS=${{ steps.typescript.outputs.typescript-status }}
          TS_ERRORS=${{ steps.typescript.outputs.typescript-errors }}
          LINT_ERRORS=${{ steps.eslint.outputs.eslint-errors }}
          PRETTIER_STATUS=${{ steps.prettier.outputs.prettier-status }}

          echo "ğŸ“Š Quality Gate Results:"
          echo "- TypeScript Status: $TS_STATUS"
          echo "- TypeScript Errors: $TS_ERRORS"
          echo "- ESLint Errors: $LINT_ERRORS"
          echo "- Prettier Status: $PRETTIER_STATUS"

          # ä¸¥æ ¼æ¨¡å¼ï¼šåŸºç¡€TypeScripté”™è¯¯å¿…é¡»ä¸º0
          if [ "$TS_ERRORS" -gt 0 ] || [ "$LINT_ERRORS" -gt 0 ] || [ "$PRETTIER_STATUS" != "passed" ]; then
            echo "âŒ Quality gate failed!"
            echo "Critical issues found that must be fixed before merge."
            exit 1
          else
            echo "âœ… Quality gate passed!"
            if [ "$TS_STATUS" != "passed" ]; then
              echo "âš ï¸  Note: Strict TypeScript check has warnings, but basic checks passed."
            fi
          fi

  # ğŸ§ª æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥
  test-coverage:
    name: ğŸ§ª Test Coverage Gate
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: cosereeden_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ—„ï¸ Setup test database
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/cosereeden_test
        run: |
          npm run db:generate
          npm run db:push

      - name: ğŸ§ª Run tests with coverage
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/cosereeden_test
          NODE_ENV: test
        run: npm run test:coverage

      - name: ğŸ“Š Coverage analysis
        id: coverage
        run: |
          if [ -f "./coverage/coverage-summary.json" ]; then
            STATEMENTS=$(node -e "console.log(JSON.parse(require('fs').readFileSync('./coverage/coverage-summary.json')).total.statements.pct)")
            BRANCHES=$(node -e "console.log(JSON.parse(require('fs').readFileSync('./coverage/coverage-summary.json')).total.branches.pct)")
            FUNCTIONS=$(node -e "console.log(JSON.parse(require('fs').readFileSync('./coverage/coverage-summary.json')).total.functions.pct)")
            LINES=$(node -e "console.log(JSON.parse(require('fs').readFileSync('./coverage/coverage-summary.json')).total.lines.pct)")

            echo "statements-coverage=$STATEMENTS" >> $GITHUB_OUTPUT
            echo "branches-coverage=$BRANCHES" >> $GITHUB_OUTPUT
            echo "functions-coverage=$FUNCTIONS" >> $GITHUB_OUTPUT
            echo "lines-coverage=$LINES" >> $GITHUB_OUTPUT

            echo "Coverage: Statements $STATEMENTS%, Branches $BRANCHES%, Functions $FUNCTIONS%, Lines $LINES%"
          else
            echo "âŒ Coverage report not found"
            exit 1
          fi

      - name: ğŸ“ˆ Coverage gate check
        run: |
          STATEMENTS=${{ steps.coverage.outputs.statements-coverage }}
          BRANCHES=${{ steps.coverage.outputs.branches-coverage }}
          FUNCTIONS=${{ steps.coverage.outputs.functions-coverage }}
          LINES=${{ steps.coverage.outputs.lines-coverage }}

          # è®¾ç½®æœ€ä½è¦†ç›–ç‡è¦æ±‚ï¼ˆé€æ­¥æå‡ï¼‰
          MIN_STATEMENTS=30
          MIN_BRANCHES=25
          MIN_FUNCTIONS=30
          MIN_LINES=30

          FAILED=false

          if (( $(echo "$STATEMENTS < $MIN_STATEMENTS" | bc -l) )); then
            echo "âŒ Statements coverage too low: $STATEMENTS% < $MIN_STATEMENTS%"
            FAILED=true
          fi

          if (( $(echo "$BRANCHES < $MIN_BRANCHES" | bc -l) )); then
            echo "âŒ Branches coverage too low: $BRANCHES% < $MIN_BRANCHES%"
            FAILED=true
          fi

          if (( $(echo "$FUNCTIONS < $MIN_FUNCTIONS" | bc -l) )); then
            echo "âŒ Functions coverage too low: $FUNCTIONS% < $MIN_FUNCTIONS%"
            FAILED=true
          fi

          if (( $(echo "$LINES < $MIN_LINES" | bc -l) )); then
            echo "âŒ Lines coverage too low: $LINES% < $MIN_LINES%"
            FAILED=true
          fi

          if [ "$FAILED" = true ]; then
            echo "âŒ Coverage gate failed!"
            exit 1
          else
            echo "âœ… Coverage gate passed!"
          fi

      - name: ğŸ“Š Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # ğŸ”’ å®‰å…¨æ£€æŸ¥
  security-check:
    name: ğŸ”’ Security Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ” Audit dependencies
        run: |
          echo "ğŸ” Running npm audit..."
          if npm audit --audit-level=high; then
            echo "âœ… No high-severity vulnerabilities found"
          else
            echo "âŒ High-severity vulnerabilities found"
            npm audit --audit-level=high
            exit 1
          fi

      - name: ğŸ”’ Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

  # ğŸ“‹ è´¨é‡é—¨ç¦æ€»ç»“
  quality-gate-summary:
    name: ğŸ“‹ Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [code-quality, test-coverage, security-check]
    if: always()
    steps:
      - name: ğŸ“Š Generate summary
        run: |
          echo "# ğŸ›¡ï¸ Quality Gate Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Coverage | ${{ needs.test-coverage.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Check | ${{ needs.security-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.code-quality.result }}" == "success" ] && [ "${{ needs.test-coverage.result }}" == "success" ] && [ "${{ needs.security-check.result }}" == "success" ]; then
            echo "## ğŸ‰ All quality gates passed! Ready for merge." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Quality gate failed. Please fix the issues before merging." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸš« Fail if any gate failed
        run: |
          if [ "${{ needs.code-quality.result }}" != "success" ] || [ "${{ needs.test-coverage.result }}" != "success" ] || [ "${{ needs.security-check.result }}" != "success" ]; then
            echo "âŒ Quality gate failed!"
            exit 1
          else
            echo "âœ… All quality gates passed!"
          fi
